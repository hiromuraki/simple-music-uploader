<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web Music Archive</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />

        <script src="/static/js/tailwindcss.js"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ["Inter", "sans-serif"],
                            mono: ["JetBrains Mono", "monospace"],
                        },
                        colors: { primary: "#6366f1", success: "#10b981", surface: "#ffffff" },
                    },
                },
            };
        </script>

        <script src="/static/js/spark-md5.min.js"></script>
        <script src="/static/js/jsmediatags.min.js"></script>
        <script src="/static/js/ffmpeg.js"></script>
        <script src="/static/js/ffmpeg-util.js"></script>

        <style>
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            /* Toast åŠ¨ç”» */
            .toast-enter {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            .toast-active {
                transform: translateX(-50%) translateY(24px);
                opacity: 1;
            }
        </style>
    </head>
    <body
        class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden selection:bg-indigo-100 selection:text-indigo-700"
    >
        <div
            id="toast"
            class="fixed left-1/2 top-0 z-50 flex items-center gap-2 px-5 py-2.5 bg-slate-800 text-white text-sm font-medium rounded-full shadow-lg transition-all duration-500 ease-out toast-enter pointer-events-none"
        >
            <svg
                class="w-4 h-4 text-success"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="3"
            >
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span id="toastMsg">å·²å¤åˆ¶</span>
        </div>

        <aside
            class="w-80 bg-white border-r border-slate-200 flex flex-col p-6 gap-5 shrink-0 z-10 shadow-sm"
        >
            <div
                class="flex items-center gap-2 pb-4 border-b border-slate-100 text-lg font-bold text-slate-900"
            >
                <span>âš¡</span> Batch Uploader
            </div>

            <div
                id="dropZone"
                onclick="document.getElementById('fileInput').click()"
                class="relative group border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 transition-all duration-200 opacity-60 pointer-events-none cursor-not-allowed grayscale"
            >
                <input
                    type="file"
                    id="fileInput"
                    accept="audio/*"
                    multiple
                    class="hidden"
                    onchange="handleFileSelect()"
                />

                <div class="text-3xl mb-3 group-hover:scale-110 transition-transform duration-200">
                    ğŸ“‚
                </div>

                <div
                    id="dropZoneTitle"
                    class="font-medium text-sm text-slate-700 flex justify-center items-center gap-2"
                >
                    <svg
                        class="animate-spin h-4 w-4 text-primary"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                        ></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                    æ­£åœ¨åŠ è½½æœ¬åœ°æ ¸å¿ƒ...
                </div>

                <div id="dropZoneSub" class="text-xs text-slate-400 mt-1">è¯·ç¨å€™</div>
            </div>

            <div
                id="queueInfo"
                class="hidden text-xs text-slate-500 bg-slate-100 p-3 rounded-lg border border-slate-200"
            >
                å¾…å¤„ç†: <strong id="queueCount" class="text-slate-800">0</strong> ä¸ªæ–‡ä»¶
            </div>

            <button
                id="uploadBtn"
                onclick="startBatchUpload()"
                disabled
                class="w-full py-3 px-4 bg-primary hover:bg-indigo-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white text-sm font-semibold rounded-lg transition-colors flex justify-center items-center gap-2 shadow-sm"
            >
                ğŸš€ ç­‰å¾…ç»„ä»¶å°±ç»ª
            </button>

            <div
                id="statusLog"
                class="flex-1 bg-slate-900 text-cyan-300 p-3 rounded-lg font-mono text-[11px] leading-relaxed overflow-y-auto border border-slate-800 shadow-inner"
            >
                <div class="opacity-50">> ç³»ç»Ÿå¯åŠ¨ä¸­ (Local Mode)...</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50">
            <header
                class="h-16 px-8 flex items-center justify-between bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-10"
            >
                <h1 class="font-semibold text-slate-800">èµ„æºåˆ—è¡¨</h1>

                <div class="flex items-center gap-3">
                    <div class="flex bg-slate-100 p-1 rounded-lg gap-1">
                        <button
                            id="sortTime"
                            onclick="changeSort('time_desc')"
                            class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-primary bg-white shadow-sm ring-1 ring-black/5"
                        >
                            ğŸ•’ æœ€æ–°
                        </button>
                        <button
                            id="sortName"
                            onclick="changeSort('name_asc')"
                            class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-700"
                        >
                            ğŸ”¤ åç§°
                        </button>
                    </div>

                    <button
                        onclick="fetchList()"
                        class="p-2 text-slate-400 hover:text-primary hover:bg-indigo-50 rounded-lg transition-colors border border-transparent hover:border-indigo-100"
                        title="åˆ·æ–°åˆ—è¡¨"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                        >
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path
                                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                            ></path>
                        </svg>
                    </button>
                </div>
            </header>

            <div
                id="musicListContainer"
                class="flex-1 overflow-y-auto p-8 grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-4 content-start"
            ></div>
        </main>

        <script>
            const Icons = {
                link: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>`,
            };
        </script>

        <script>
            const { FFmpeg } = FFmpegWASM;
            const { fetchFile } = FFmpegUtil;
            let ffmpeg = null;
            let fileQueue = [];
            let isProcessing = false;
            let musicDataList = [];
            let currentSortMode = "time_desc";

            const logEl = document.getElementById("statusLog");
            const uploadBtn = document.getElementById("uploadBtn");
            const dropZone = document.getElementById("dropZone");
            const dropZoneTitle = document.getElementById("dropZoneTitle");
            const dropZoneSub = document.getElementById("dropZoneSub");

            function log(msg, type = "info") {
                const div = document.createElement("div");
                div.textContent = `> ${msg}`;
                div.className = "mb-1";
                if (type === "success") div.className += " text-emerald-400";
                if (type === "error") div.className += " text-rose-400";
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }

            // --- 1. åˆå§‹åŒ– FFmpeg ---
            async function initFFmpeg() {
                ffmpeg = new FFmpeg();
                ffmpeg.on("log", ({ message }) => {
                    if (!message.includes("size=") && !message.includes("time="))
                        console.log(message);
                });

                try {
                    // æœ¬åœ°åŠ è½½
                    await ffmpeg.load({
                        coreURL: "/static/js/ffmpeg-core.js",
                        wasmURL: "/static/js/ffmpeg-core.wasm",
                    });

                    log("æœ¬åœ° FFmpeg å†…æ ¸åŠ è½½å®Œæ¯•", "success");

                    // è§£é”ç•Œé¢
                    dropZone.classList.remove(
                        "opacity-60",
                        "pointer-events-none",
                        "cursor-not-allowed",
                        "grayscale",
                    );
                    dropZone.classList.add(
                        "cursor-pointer",
                        "hover:border-primary",
                        "hover:bg-indigo-50",
                    );

                    dropZoneTitle.innerHTML = "ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶";
                    dropZoneSub.textContent = "æ”¯æŒæ‰¹é‡æ’é˜Ÿå¤„ç†";

                    uploadBtn.textContent = "ğŸš€ å¼€å§‹å¤„ç†";
                } catch (e) {
                    log("FFmpeg åŠ è½½å¤±è´¥ (è¯·æ£€æŸ¥ static/js ç›®å½•)", "error");
                    console.error(e);
                    dropZoneTitle.innerHTML = '<span class="text-rose-500">ç»„ä»¶åŠ è½½å¤±è´¥</span>';
                    dropZoneSub.textContent = "æ— æ³•åŠ è½½ WASM æˆ– JS æ–‡ä»¶";
                }
            }

            // --- 2. äº¤äº’é€»è¾‘ ---
            function handleFileSelect() {
                const input = document.getElementById("fileInput");
                if (input.files.length) {
                    fileQueue = Array.from(input.files);
                    document.getElementById("queueCount").textContent = fileQueue.length;
                    document.getElementById("queueInfo").classList.remove("hidden");

                    if (ffmpeg && fileQueue.length > 0) uploadBtn.disabled = false;
                }
            }

            async function startBatchUpload() {
                if (isProcessing || fileQueue.length === 0 || !ffmpeg) return;

                isProcessing = true;
                uploadBtn.disabled = true;
                dropZone.classList.add("opacity-60", "pointer-events-none");

                log(`å¼€å§‹é˜Ÿåˆ—: ${fileQueue.length} ä¸ªæ–‡ä»¶...`);

                for (let i = 0; i < fileQueue.length; i++) {
                    const file = fileQueue[i];
                    log(`[${i + 1}/${fileQueue.length}] å¤„ç†: ${file.name}`);
                    try {
                        await processSingleFile(file);
                    } catch (error) {
                        log(`âŒ ${file.name} å¤±è´¥`, "error");
                    }
                }
                log("é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨å®Œæˆ", "success");

                isProcessing = false;
                fileQueue = [];
                document.getElementById("fileInput").value = "";
                document.getElementById("queueInfo").classList.add("hidden");
                dropZone.classList.remove("opacity-60", "pointer-events-none");
                fetchList();
            }

            async function processSingleFile(file) {
                const [coverBase64, duration] = await Promise.all([
                    getCoverArt(file),
                    getDuration(file),
                ]);

                const inputName = "input_audio";
                const outputName = "output.mp3";
                try {
                    await ffmpeg.deleteFile(inputName);
                } catch (e) {}
                try {
                    await ffmpeg.deleteFile(outputName);
                } catch (e) {}

                await ffmpeg.writeFile(inputName, await fetchFile(file));
                await ffmpeg.exec(["-i", inputName, "-b:a", "192k", outputName]);

                const data = await ffmpeg.readFile(outputName);
                const mp3Blob = new Blob([data.buffer], { type: "audio/mp3" });

                const fullHash = await calculateMD5(mp3Blob);
                const shortHash = fullHash.substring(0, 16);
                const finalFilename = `${shortHash}.mp3`;

                const metadata = {
                    original_name: file.name,
                    duration: duration,
                    cover_base64: coverBase64 || "",
                };

                const formData = new FormData();
                formData.append("audio", mp3Blob, finalFilename);
                formData.append("metadata", JSON.stringify(metadata));

                const res = await fetch("/upload", { method: "POST", body: formData });
                if (!res.ok) throw new Error("æœåŠ¡å™¨è¿”å›é”™è¯¯");

                await ffmpeg.deleteFile(inputName);
                await ffmpeg.deleteFile(outputName);
            }

            // --- è¾…åŠ©å·¥å…· ---
            function getCoverArt(file) {
                return new Promise((resolve) => {
                    jsmediatags.read(file, {
                        onSuccess: async function (tag) {
                            const { picture } = tag.tags;
                            if (picture) {
                                let str = "";
                                for (let i = 0; i < picture.data.length; i++)
                                    str += String.fromCharCode(picture.data[i]);
                                const raw =
                                    "data:" + picture.format + ";base64," + window.btoa(str);
                                resolve(await compressImage(raw));
                            } else resolve(null);
                        },
                        onError: () => resolve(null),
                    });
                });
            }

            function compressImage(base64Str) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        canvas.width = 256;
                        canvas.height = 256;
                        canvas.getContext("2d").drawImage(img, 0, 0, 256, 256);
                        resolve(canvas.toDataURL("image/jpeg", 0.8));
                    };
                    img.onerror = () => resolve(base64Str);
                    img.src = base64Str;
                });
            }

            function getDuration(file) {
                return new Promise((r) => {
                    const a = new Audio(URL.createObjectURL(file));
                    a.onloadedmetadata = () => r(Math.round(a.duration));
                    a.onerror = () => r(0);
                });
            }

            function calculateMD5(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsArrayBuffer(blob);
                    reader.onload = (e) => {
                        const spark = new SparkMD5.ArrayBuffer();
                        spark.append(e.target.result);
                        resolve(spark.end());
                    };
                    reader.onerror = reject;
                });
            }

            // --- åˆ—è¡¨æ¸²æŸ“ ---
            async function fetchList() {
                try {
                    const res = await fetch("/api/list");
                    musicDataList = await res.json();
                    renderList();
                } catch (e) {
                    console.error(e);
                }
            }

            function changeSort(mode) {
                if (currentSortMode === mode) return;
                currentSortMode = mode;
                const btnTime = document.getElementById("sortTime");
                const btnName = document.getElementById("sortName");
                const activeClass = "text-primary bg-white shadow-sm ring-1 ring-black/5";
                const inactiveClass = "text-slate-500 hover:text-slate-700";

                if (mode === "time_desc") {
                    btnTime.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
                    btnName.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
                } else {
                    btnTime.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
                    btnName.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
                }
                renderList();
            }

            function renderList() {
                const container = document.getElementById("musicListContainer");
                const list = [...musicDataList];

                list.sort((a, b) => {
                    if (currentSortMode === "time_desc") return b.upload_time - a.upload_time;
                    if (currentSortMode === "name_asc")
                        return a.original_name.localeCompare(b.original_name);
                    return 0;
                });

                if (list.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center pt-10 text-slate-400">æš‚æ— æ–‡ä»¶ï¼Œè¯·åœ¨å·¦ä¾§ä¸Šä¼ </div>`;
                    return;
                }

                container.innerHTML = list
                    .map((item) => {
                        const url = `${window.location.origin}/resources/music/${item.filename}`;
                        const cover = item.cover_base64
                            ? `<img src="${item.cover_base64}" class="w-[72px] h-[72px] rounded-lg bg-slate-200 object-cover shrink-0 border border-slate-100">`
                            : `<div class="w-[72px] h-[72px] rounded-lg bg-slate-100 flex items-center justify-center text-2xl text-slate-300 shrink-0 border border-slate-100">ğŸµ</div>`;

                        const min = Math.floor(item.duration / 60);
                        const sec = (item.duration % 60).toString().padStart(2, "0");

                        return `
                    <div class="group relative bg-white border border-slate-200 rounded-xl p-3 flex items-center gap-3 transition-all hover:border-indigo-200 hover:shadow-md hover:-translate-y-0.5">
                        ${cover}
                        <div class="flex-1 min-w-0 flex flex-col justify-center gap-1.5">
                            <div class="font-semibold text-sm text-slate-800 truncate cursor-pointer hover:text-primary hover:underline decoration-indigo-200 decoration-2"
                                 title="å¤åˆ¶: ${item.original_name}" 
                                 onclick="copyText('${item.original_name}', this)">
                                ${item.original_name}
                            </div>
                            
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <div class="bg-slate-50 border border-slate-100 px-1.5 py-0.5 rounded cursor-pointer hover:text-primary hover:border-indigo-100"
                                     title="å¤åˆ¶ç§’æ•°: ${item.duration}" 
                                     onclick="copyText('${item.duration}', this)">
                                    æ—¶é•¿ ${min}:${sec}
                                </div>
                                <div class="font-mono text-slate-400 bg-slate-50 border border-slate-100 px-1.5 py-0.5 rounded">
                                    ${item.id.substring(0, 6)}
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="copyText('${url}', this)" 
                                class="w-8 h-8 flex items-center justify-center rounded-lg border border-slate-200 text-slate-400 hover:text-primary hover:bg-indigo-50 hover:border-indigo-200 transition-colors shrink-0"
                                title="å¤åˆ¶ä¸‹è½½é“¾æ¥">
                            ${Icons.link}
                        </button>
                    </div>
                `;
                    })
                    .join("");
            }

            // --- Toast & Copy ---
            let toastTimeout;
            async function copyText(text, el) {
                try {
                    await navigator.clipboard.writeText(text);

                    const toast = document.getElementById("toast");
                    const msg = document.getElementById("toastMsg");
                    if (text.length > 20) text = text.substring(0, 15) + "...";
                    msg.textContent = `å·²å¤åˆ¶: ${text}`;

                    toast.classList.remove("toast-enter");
                    toast.classList.add("toast-active");

                    clearTimeout(toastTimeout);
                    toastTimeout = setTimeout(() => {
                        toast.classList.remove("toast-active");
                        toast.classList.add("toast-enter");
                    }, 2000);

                    if (el.tagName === "BUTTON") {
                        const originalClass = el.className;
                        el.className =
                            "w-8 h-8 flex items-center justify-center rounded-lg border border-emerald-200 text-emerald-500 bg-emerald-50 shrink-0 transition-all";
                        el.innerHTML = "âœ”";
                        setTimeout(() => {
                            el.className = originalClass;
                            el.innerHTML = Icons.link;
                        }, 600);
                    } else {
                        const oldColor = el.style.color;
                        el.style.color = "#10b981";
                        setTimeout(() => (el.style.color = oldColor), 400);
                    }
                } catch (err) {
                    console.error(err);
                }
            }

            initFFmpeg();
            fetchList();
        </script>
    </body>
</html>
